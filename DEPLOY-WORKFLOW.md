# 배포

## 현황

- 아사나 배포관리에 태스크 생성
  - 2026.01.06 hybris, kop-cms
  - 대상 태스크 입력
- 빌드하고
  - 하이브리스 머지하고 브랜치 따고 푸시
- asana에 빌드 번호 넣어주고
- 베타에 올린다
  - 배포내용 한번 확인
  - QA방 채팅방에 qa 요청한다
  - ks, tc, g4 만 결제 테스트 돌린다
- 아사나에 다른 필드들 채워준다
  - 배포등급 : A는 그냥 스케일인,아웃 정도
  - 작성 후 진표이사님에게 아사나 드리면서 배포 승인 요청
- 배포
  - 하이브리스
    - grafana 확인 후 퍼플/그린 확인
      - deploy-2023-prod 가서 image랑 replicaCount 설정
      - 보통 normal로 9대
      - grafana에서 JGRP 지표 확인
        - 요동치지 않아야함
        - 만약 이슈 발생시 조동우팀장님이나 정수님께 문의
    - hybris-prod
      - 3개의 hybrisServiceName을 해당 배포상태로 변경
      - grafana에서 Hybris ERROR 지표 확인
  - cms
    - pre-release에서 branch 따서 master로 MR 생성 후파이프라인 돌리고
    - 마스터 머지
    - internal이랑 그냥 둘다 배포
  - web
    - 하나로 되어있어서 전부 싱크
  - 배포 시 커밋 메시지에 배포내용 넣어주기
- 공유방에 배포 안내
- 배포 후 하이브리스는 3대씩 찬찬히 내리기

```
[kop] 배포합니다.
- 배포버전: hybris(deploy-2026-01-08), web(a7ed4db1),
cms(6e27011f)
- 배포등급: B(낮음)
- DB 업데이트 여부: N
- 배포내역
	- [버티컬] 대표이사 성명 변경 작업 원복
	- [HYBRIS] 푸터 대표이사 성명 변경 작업 원복
	- [CMS] KS CMS-상세HTML 수정 요청
	- [CMS] KS 템플릿 업데이트
```

#### 운영*배포*자동화 희망사항

- argocd에서는 하나의 앱만 관리할 수 있는데
- 여러 앱들을 한번에 상태확인하고 배포할 수 있을까
- 하이브리스 신호 감지해서 배포 필요
- iac 환경에서 코드를 수정해야 배포가 수정되는데 손이 더 가는거 같다. iac도 현행유지를 하면서 더 편리하게 할 방법 있을까? 버튼 누르면 code update 할 수 있을까
- 현행
  - 배포 안내(내부) -> 빌드 -> kop-deploy-prod 코드 수정 -> 배포내용 정리 -> 베타 배포 및 QA 요청 -> _서비스 영향도 및 배포등급 검토_ -> 아사나에 배포 이력 작성 -> _상급자 리뷰 & 승인_ -> 배포 (하이브리스 블루 그린 5, 10, 15) -> _상급자 테스트 결과 체크 승인_ -> 최종 배포방에 공지 -> 하이브리스 스위칭
  - 추가된 것
    - 베타 테스트 후 서비스 영향도 및 배포등급 검토 -> 배포 내용 정리할때 하면 될 듯
    - 상급자 리뷰 & 승인
    - 배포 후 테스트 후 상급자 테스트 결과 체크 승인
- 배포는 버튼만 누르고 모니터링만 하도록
  - [ ] 1.  빌드 자동화
    - ci 파이프라인에서 추가
    - jenkins build를 쳐줘야하는걸 해야되서 안됐었나보다
    - 그래서 jenkins 에서 빌드를 했나보다
    - jenkins에서 빌드 원격으로 유발 켜고 웹훅 주소 받아서 gitlab에서 curl로 호출
  - [ ] 3.  배포내용 정리 및 아사나 업로드 자동화
  - [ ] 2.  하이브리스 스케일 조절 자동화
    - 하이브리스에서 제대로 떴다는 신호를 어떻게 알 수 있나
      - readnessprobe, livenessprobe는 기본
      - cluster/status 같은 api 만들어서 jgroup view가 예상 노드 수와 같은지 확인
    - argo rollout으로 canary로 적당히 pause 주면서 스케일 늘려갈 수 있다
- 수동으로 관리해야할 부분
  - 어떤게 변경되는지에 대한 인지
  - 변경사항에 대한 성공여부 확인
  - 진행 중 문제 생기면 즉시 중지 후 수정 가능해야함
- 주의
  - 정확히 배포되야할 내용만 배포되어야 한다. 섞여 들어가면 안됨
  - 디비 수정건에 대한 확인 필요
  - 커맨드로 되는 부분 (git branch)과 명령으로 되는 부분 (curl) 구분 필요
- argocd app of apps
  - settings -> projects -> vertical-test -> destinations에 namespace에 argocd 추가 필요했음
- readnessprobe, livenessprobe

#### 배포 희망사항

- 슬랙으로 빌드 및 배포
  - 나중에는 세팅하는거도 슬랙으로 할 수 있으면 좋겠다
  - 일단 gitlab에서 jenkins 돌리고
  - gitlab을 slack으로 이벤트 받고
  - argocd는 slack으로 돌리고
    - 이건 근데 gitlab을 업데이트하고 argo 싱크도 해야함 gitops라서
  - 메시지 잘 받아야함
  - 우려되는 것
    - 권한 관리
    - 이력 증명
    - 에러 메시지 확인
  - /setup
  - /deploy
  - /배포준비 - 앱 선택
  - /배포 하이브리스
    - 블루 그린인지 3->6인지
  - /rollback
  - /status
- 배포 프로세스를 개선할 수 있을까
  - 코드의 수정이 화면에서 이루어질 수 있을까
  - 배포 후 테스트가 자동으로 이루어지고 사람도 직접 확인한다
- 두가지 문제
  - 배포가 너무 잦고 불규칙하다
  - 배포가 너무 복잡하다. 하이브리스는 너무 무겁다
  - 이기종 버전 배포 시 문제 없을까

#### 서비스 배포 등급

|      |           |                                                           |                                       |                             |
| ---- | --------- | --------------------------------------------------------- | ------------------------------------- | --------------------------- |
| 등급 | 위험도    | 등급 기준                                                 | 검토 승인                             | 내부 공유                   |
| A    | 매우 낮음 | 피처 플래그 토글, 안전한 구성 값 변경                     | PL 승인 (직접 작성 시 팀장승인)       | 팀내 공유                   |
| B    | 낮음      | 일반적인 컨텐츠/UI 개선, 비핵심 서비스 패치               | PL 승인 (직접 작성 시 팀장승인)       | 팀내 공유                   |
| C    | 중간      | API 추가, 실시간서비스 외 인프라 변경건                   | 서비스 팀장                           | 핵심서비스 담당 PL이상 공유 |
| D    | 높음      | DB 스키마 변경, 트래픽 경로 변경, 핵심 서비스, 인프라변경 | 서비스 담당 팀장 / 인프라 담당 상급자 | 핵심서비스 담당 PL이상 공유 |
| E    | 특수      | 장애 대응용 또는 긴급 개선용 패치 (선조치 후보고)         | 장애 서비스 담당 팀장                 | 해당 서비스 담당 공유       |
